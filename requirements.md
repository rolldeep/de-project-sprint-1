# 1.1. Выясните требования к целевой витрине.

### Полученные требования
1. Где витрина должна находится -  в той же базе, в схеме analysis.
2. Структура витрины - витрина должна состоять из таких полей: user_id; recency (число от 1 до 5); frequency (число от 1 до 5); monetary_value (число от 1 до 5)
3. Необходимая глубина данных - с начала 2022 года.
4. Название витрины - dm_rfm_segments.
5. Как часто витрина должна обноляться  - обновления не нужны.
6. Зачем нужна витрина - для RFM-классификации пользователей приложения.
	Заказчик — компания, которая разрабатывает приложение по доставке еды.
7. Дополнительно - успешно выполненый заказ, это заказ со статусом Closed.

### Вопросы без ответов
1. Витрина должна быть доступна всем или ограниченному кругу лиц ???
2. Вид доступа (чтение, запись, редактирование) ???
3. Делались ли схожие витрины ???
4. Есть ли ограничения по срокам ???

# 1.2. Изучите структуру исходных данных.

### Структура данных
На входе имеем 6 таблиц
1. users
Таблица с данными о клиенте. Содержит уникальный id клиента ФИО и логин. Поля name и login перепутаны по содержанию, данные из login должны быть в name и наоборот.
Связь - нет связей.
2. orderitems
Таблица с деталями заказа. Содержит уникальный id, id заказа, id продукта, название продукта, цену каждого продукта, скидку (если есть) и кол-во каждого продукта в заказе.
Связь - orders; products.
3. orders
Таблица с заказами. Отображает id заказа, время статуса, стоимость заказа, информацию о бонусах. Содержит заказы только с конечным статусом (Closed, Cancelled).
Связь - orderitems; orderstatuslog.
4. orderstatuses
Справочник с расшифровкой статусов заказа.
Связь - orderstatuslog.
5. products
Таблица описывающая цену для каждого продукта.
Связь - orderitems.
6. orderstatuslog
Таблица с историей изменения статуса и времени статуса по каждому заказу.
Связь - orderstatuslog; orders.

### Описание решения
1. В CTE "source_tbl" из таблицы orders берем все заказы со статусом 4 (закрытый-оплаченный заказ). Считаем кол-во дней с даты последнего закрытого заказа. От сегодняшней даты вычитаем дату закрытого заказа. Для определения даты посленего заказа для каждого пользователя используем оконной функцию.
2. В CTE "recency" выводим user_id и дату последнего заказа.
3. В CTE "prev_tbl" из таблицы users берем всех user_id. Рассчитываем Recency, Frequency, Monetary. Рассчитываем количество и сумму всех закрытых заказов, а также поле Recency джойним из CTE recency. Все это мерджим к user_id из users/ 
4. В CTE "batch" для каждго фактор присваиваем распределите по шкале от 1 до 5. Для этого используем процентили 20% 40% 60% 80% для каждого фактора соответственно.
5. В CTE "rfm" каждый фактор распределяем в одну из 5 групп.
6. В результирующей таблице выводим необходимые поля.

### Необходимые поля для расчёта витрины
Таблица - orders; Поля - user_id ,order_id, order_ts, payment
Таблица - users; Поля - user_id
current_date

Рассчётные поля:
- delta_dt = current_date - cast(order_ts as date)		--дельта в днях с момента заказа;
- max_dt = max(order_ts) over (partition by user_id)	--последная дата заказа по каждому пользователю;
- recency = delta_dt;
- frequency = count(distinct order_id)					--кол-во заказвов по каждому пользователю;
- monetary = sum(payment)								--оплаченная сумма всех заказво по каждому пользователю;

















